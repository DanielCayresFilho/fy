FROM php:8.3-fpm

# Instalar dependÃªncias do sistema + nginx
RUN apt-get update && apt-get install -y \
    git \
    curl \
    libpng-dev \
    libonig-dev \
    libxml2-dev \
    libpq-dev \
    zip \
    unzip \
    nginx \
    supervisor \
    && docker-php-ext-install pdo pdo_pgsql pgsql mbstring exif pcntl bcmath gd \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Instalar Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Configurar diretÃ³rio de trabalho
WORKDIR /var/www

# Copiar arquivos do projeto
COPY . /var/www

# Instalar dependÃªncias do Composer
RUN composer install --optimize-autoloader --no-dev --no-interaction

# Copiar configuraÃ§Ã£o do nginx
COPY docker/nginx/nginx.conf /etc/nginx/nginx.conf
COPY docker/nginx/default.conf /etc/nginx/sites-available/default

# Copiar configuraÃ§Ã£o do supervisor
COPY docker/supervisor/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Criar diretÃ³rios necessÃ¡rios
RUN mkdir -p /var/log/supervisor /run/php

# Configurar permissÃµes
RUN chown -R www-data:www-data /var/www \
    && chmod -R 755 /var/www/storage \
    && chmod -R 755 /var/www/bootstrap/cache

# Criar script de inicializaÃ§Ã£o inline (evita problemas de CRLF)
RUN cat > /usr/local/bin/start.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸš€ Starting Fy API..."

# Verificar se .env existe, senÃ£o copiar do example
if [ ! -f /var/www/.env ]; then
    echo "âš™ï¸  .env not found, copying from .env.example..."
    cp /var/www/.env.example /var/www/.env
fi

# Gerar APP_KEY se nÃ£o existir
if ! grep -q "APP_KEY=base64:" /var/www/.env; then
    echo "ğŸ”‘ Generating APP_KEY..."
    php artisan key:generate --force
fi

# Gerar JWT_SECRET se nÃ£o existir ou estiver vazio
if ! grep -q "JWT_SECRET=.*[a-zA-Z0-9]" /var/www/.env; then
    echo "ğŸ” Generating JWT_SECRET..."
    php artisan jwt:secret --force || echo "âš ï¸  JWT secret generation skipped"
fi

# Aguardar banco de dados estar pronto (mÃ¡x 30 segundos)
echo "â³ Waiting for database..."
for i in {1..30}; do
    if php artisan db:show > /dev/null 2>&1; then
        echo "âœ… Database connection successful!"
        break
    fi
    echo "   Attempt $i/30 - waiting for database..."
    sleep 1
done

# Executar migrations
echo "ğŸ“Š Running migrations..."
php artisan migrate --force || echo "âš ï¸  Migration failed or no pending migrations"

# Limpar e cachear configuraÃ§Ãµes
echo "ğŸ—‘ï¸  Clearing caches..."
php artisan config:clear
php artisan route:clear
php artisan view:clear

echo "ğŸ’¾ Caching configurations..."
php artisan config:cache
php artisan route:cache

# Garantir permissÃµes corretas
echo "ğŸ”’ Setting permissions..."
chown -R www-data:www-data /var/www/storage /var/www/bootstrap/cache
chmod -R 775 /var/www/storage /var/www/bootstrap/cache

echo "âœ… Laravel setup complete!"
echo "ğŸŒ Starting nginx and php-fpm via supervisor..."

# Iniciar supervisor
exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
EOF

# Dar permissÃ£o de execuÃ§Ã£o
RUN chmod +x /usr/local/bin/start.sh

# Porta configurÃ¡vel via ENV (padrÃ£o 80)
ENV PORT=80
EXPOSE ${PORT}

# Iniciar via script
CMD ["/usr/local/bin/start.sh"]
